---
title: "Script linked to Figure 4: Pallial and subpallial qNSCs are distinguished by Hopx expression."
subtitle: "Figure 3A, 3C, 3D, 3M"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "chaos"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Load packages

```{r,warning=FALSE, include=T}
suppressWarnings(suppressMessages({
library(AUCell,quietly=T)
library(devtools,quietly=T)
library(tidyverse,quietly=T)
library(Seurat,quietly=T)
library(gridExtra,quietly=T)
library(gt,quietly=T)
library(glue,quietly=T)
library(scater,quietly=T)
library(tm,quietly=T)
library(gghalves,quietly=T)
library(broman,quietly=T)
library(viridis,quietly=T)
library(Cairo,quietly=T)
library(hrbrthemes,quietly=T)
library(ggplot2,quietly=T)
library(cowplot,quietly=T)
library(ggrepel,quietly=T)
library(plyr,quietly=T)
library(grid,quietly=T)
library(doRNG,quietly=T)
library(doSNOW,quietly=T)
library(mixtools,quietly=T)
library(SummarizedExperiment,quietly=T)
library(DT,quietly=T)
library(plotly,quietly=T)
library(NMF,quietly=T)
library(shiny,quietly=T)
library(rbokeh,quietly=T)
library(dynamicTreeCut,quietly=T)
library(R2HTML,quietly=T)
library(Rtsne,quietly=T)
library(zoo,quietly=T)
library(GSEABase,quietly=T)
library(magrittr, quietly=T)
library(imager, quietly=T)
library(EBImage, quietly=T)
library(STutility, quietly=T)
library(magrittr, quietly=T)
library(dplyr, quietly=T)
library(DT, quietly=T)
library(kableExtra, quietly=T)
library(ggpubr, quietly = T)
}))
```

```{r, warning=FALSE}
same_umap_P2_P12_P22=readRDS("C:/Users/raine/OneDrive/Documents/BioInfo/newdataset/same_umap_P2_P12_P22.rds")
Idents (same_umap_P2_P12_P22) = "orig.ident"
P12 <- subset(same_umap_P2_P12_P22,idents = c("sdCLBNx1","sdCLBNx2"))
```

# A

> Fig4A: UMAP highlighting 3 qNSCs subclusters.

```{r,fig.width=5,fig.height=4,fig.align="center"}
Idents(P12) = "Full_clusters"

qNSC3 = WhichCells(P12, idents = "P12_qNSC3")
qNSC1 = WhichCells(P12, idents = "P12_qNSC2")
qNSC2 = WhichCells(P12, idents = "P12_qNSC3")

DimPlot(P12, label = F,label.size = 4, pt.size = 1,repel=T,cols= c("#DEDEDE","#6F4D0F","#C59226","#EDC251","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE","#DEDEDE"))+NoLegend()

```

# C

> Fig4C: Dot plot analysis revealing that some TFs/TRs are enriched or exclusive to a specific cluster.

```{r,fig.align="center"}
DefaultAssay(P12)="RNA"
suppressWarnings(suppressMessages(DotPlot(P12, features = c("Gsx2","Six3","Rorb","Eno1","Id4","Id3","Id2","Id1","Hopx","Fezf2","Dmrta2","Zic5","Tfap2c","Emx1"), idents = c("P12_qNSC1","P12_qNSC2","P12_qNSC3"), dot.scale = 10)+scale_colour_viridis(option="viridis")+theme_grey()+RotatedAxis()))
```

# D

> Fig4D: Spatial transcriptomic (Visium) showing the expression of Sox2 and Hopx.

```{r}
se.cropped=readRDS("C:/Users/raine/OneDrive/Documents/visium/merge_se_cropped.rds")
suppressMessages(suppressWarnings(se.cropped <- suppressMessages(se.cropped %>% 
  SCTransform(verbose = F) %>%
  RunPCA(verbose=F) %>%
  RunUMAP(reduction = "pca", dims = 1:20,verbose = F))))

```

```{r, fig.width=10, fig.height=3,fig.align="center"}

FeatureOverlay(se.cropped, features = "Sox2",
sampleids = 1:4,
cols = c("light grey", "mistyrose", "darkred"),
pt.size = 3,
add.alpha = TRUE,
ncol = 4, show.sb = FALSE,
pt.alpha = 0.1)

FeatureOverlay(se.cropped, features = "Hopx",
sampleids = 1:4,
cols = c("light grey", "mistyrose", "darkred"),
pt.size = 3,
add.alpha = TRUE,
ncol = 4, show.sb = FALSE,
pt.alpha = 0.1)

```

# M

> Fig4M: Calculation of an AUCell score using best astrocytic markers defined by Zeisel et al., Cell, 2018.

```{r,warning=FALSE,include=F}
Astro_Zeisel = c("Fam107a",
        "Cbs",
        "Mlc1",
        "Ntsr2",
        "Clu",
        "Ppp1r3g",
        "Gm11627",
        "Mfge8",
        "Cldn10",
        "S1pr1")

data_matrix <- GetAssayData(same_umap_P2_P12_P22, assay = "RNA")
data_matrix <- as.matrix(data_matrix)

astroSets10 = Astro_Zeisel
astroSets10 <- GeneSet(astroSets10, setName= "astroSets10")
CellTypes10 <- GeneSetCollection(astroSets10)
ranking <- AUCell_buildRankings(data_matrix)

AUC_10 <- AUCell_calcAUC(CellTypes10, ranking)
rankings10 <- apply(AUC_10@assays@data@listData[["AUC"]], 1, function(x) (x-min(x))/(max(x)-min(x))) 
rankings10 <- as.data.frame(rankings10)
rankings10$class <- as.data.frame(same_umap_P2_P12_P22@meta.data$predicted.fullcelltype, row.names = Cells(same_umap_P2_P12_P22))[row.names(rankings10),]
```
```{r,warning=FALSE,fig.align="center"}

my_comparisons <- list(c("P12_Astrocytes", "P12_qNSC1"), 
                       c("P12_Astrocytes", "P12_qNSC2"), 
                       c("P12_qNSC1", "P12_qNSC2"))

astro_quiescent <- c("P12_Astrocytes" = "#B882FC","P12_qNSC1" = "#75540D" , "P12_qNSC2"="#CB9B20")

suppressMessages(suppressWarnings(rankings10 %>%
  filter(class == "P12_qNSC1" |
          class == "P12_qNSC2" | 
      class == "P12_Astrocytes" ) %>%
  ggplot(aes(x = class, y = astroSets10,fill=class)) +
  geom_violin(trim = F,position = "dodge")+ggtitle("AUCell score astrocytes markers")+stat_compare_means(label="p.signif",comparisons = my_comparisons)+
  ylab("AUCell score")+theme_ipsum()+ scale_x_discrete("class", limits = c("P12_qNSC1", "P12_qNSC2","P12_Astrocytes"),labels=c("qNSC1","qNSC2","Astro"))+
  scale_fill_manual(values=astro_quiescent)+NoLegend()))

```
